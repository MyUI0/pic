name: Update Subscription Feed with Bark Notifications

on:
  # æ¯ä¸¤å¤©è¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´0ç‚¹ï¼‰
  schedule:
    - cron: '0 0 */2 * *'
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      send_test:
        description: 'å‘é€æµ‹è¯•é€šçŸ¥'
        required: false
        default: false
        type: boolean
  # ä»£ç æ¨é€æ—¶è§¦å‘æµ‹è¯•
  push:
    branches: [ main ]

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ğŸ”” å‘é€å¼€å§‹é€šçŸ¥
      if: ${{ github.event.inputs.send_test != 'true' }}
      id: notify-start
      run: |
        echo "ğŸ”” å‘é€å·¥ä½œæµå¼€å§‹é€šçŸ¥..."
        
        # æ£€æŸ¥Barkè®¾å¤‡å¯†é’¥
        if [ -z "${{ secrets.BARK_DEVICE_KEY }}" ]; then
          echo "âš ï¸  BARK_DEVICE_KEYæœªè®¾ç½®ï¼Œè·³è¿‡Barké€šçŸ¥"
          echo "skip_bark=true" >> $GITHUB_OUTPUT
        else
          echo "âœ… Barkè®¾å¤‡å¯†é’¥å·²é…ç½®"
          echo "skip_bark=false" >> $GITHUB_OUTPUT
          
          # å‘é€å¼€å§‹é€šçŸ¥
          TITLE="ğŸ”„ è®¢é˜…æºæ›´æ–°å¼€å§‹"
          BODY="å¼€å§‹æ‰§è¡Œè®¢é˜…æºæ›´æ–°ä»»åŠ¡\n\nä»“åº“: ${{ github.repository }}\næ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\nè§¦å‘æ–¹å¼: ${{ github.event_name }}"
          
          curl -s -X GET \
            "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}/$TITLE/$BODY?group=subscription-update&sound=bell&isArchive=1" \
            --max-time 10 || echo "âš ï¸  å¼€å§‹é€šçŸ¥å‘é€å¤±è´¥"
        fi
        
    - name: ğŸ”” å‘é€æµ‹è¯•é€šçŸ¥ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
      if: ${{ github.event.inputs.send_test == 'true' }}
      run: |
        echo "ğŸ§ª å‘é€æµ‹è¯•é€šçŸ¥..."
        
        if [ -z "${{ secrets.BARK_DEVICE_KEY }}" ]; then
          echo "âŒ é”™è¯¯: BARK_DEVICE_KEYæœªè®¾ç½®"
          echo "è¯·åœ¨GitHubä»“åº“Settings â†’ Secretsä¸­è®¾ç½®BARK_DEVICE_KEY"
          exit 1
        fi
        
        TITLE="ğŸ”” Barké€šçŸ¥æµ‹è¯•"
        BODY="è¿™æ˜¯ä¸€æ¡æµ‹è¯•é€šçŸ¥ï¼Œç”¨äºéªŒè¯Barké…ç½®æ˜¯å¦æ­£ç¡®ã€‚\n\nä»“åº“: ${{ github.repository }}\næ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        
        curl -s -X GET \
          "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}/$TITLE/$BODY?group=test&sound=bell&badge=1" \
          --max-time 10
        
        echo "âœ… æµ‹è¯•é€šçŸ¥å·²å‘é€"
        echo "è¯·æ£€æŸ¥æ‚¨çš„iPhoneæ˜¯å¦æ”¶åˆ°é€šçŸ¥"
        
    - name: ğŸ”„ è§£æå¹¶æ›´æ–°è®¢é˜…æº
      id: update-feeds
      run: |
        # åˆ›å»ºfeedsç›®å½•
        mkdir -p feeds
        
        # åˆå§‹åŒ–å˜é‡
        V2RAY_COUNT=0
        CLASH_COUNT=0
        UPDATE_STATUS="success"
        ERROR_MSG=""
        
        # === 1. è·å–READMEå†…å®¹ ===
        echo "ğŸ” æ­£åœ¨è·å–æºé¡¹ç›®README..."
        README_URL="https://raw.githubusercontent.com/free-clash-v2ray/free-clash-v2ray.github.io/main/README.md"
        README_CONTENT=$(curl -s -L "$README_URL" --max-time 30 2>/dev/null || echo "")
        
        if [ -z "$README_CONTENT" ]; then
          echo "âš ï¸  æ— æ³•è·å–READMEï¼Œä½¿ç”¨å¤‡ç”¨é“¾æ¥"
          V2RAY_URL="https://free-clash-v2ray.github.io/uploads/2026/02/0-20260216.txt"
          CLASH_URL="https://free-clash-v2ray.github.io/uploads/2026/02/0-20260216.yaml"
        else
          # === 2. æå–æœ€æ–°V2Rayé“¾æ¥ ===
          echo "ğŸ” æå–V2Rayé“¾æ¥..."
          V2RAY_LINKS=$(echo "$README_CONTENT" | grep -oE "https://[^\s\"]+\.txt" | grep "free-clash-v2ray" || true)
          
          if [ -n "$V2RAY_LINKS" ]; then
            # æå–æœ€æ–°æ—¥æœŸçš„é“¾æ¥
            V2RAY_URL=$(echo "$V2RAY_LINKS" | python3 -c "
import sys, re
links = sys.stdin.read().strip().split('\n')
dated_links = []
for link in links:
    match = re.search(r'/(\d{8})\.txt', link)
    if match:
        date_str = match.group(1)
        dated_links.append((date_str, link))

if dated_links:
    dated_links.sort(reverse=True)
    print(dated_links[0][1])
else:
    print(links[0] if links else '')
" 2>/dev/null)
          fi
          
          # === 3. æå–æœ€æ–°Clashé“¾æ¥ ===
          echo "ğŸ” æå–Clashé“¾æ¥..."
          CLASH_LINKS=$(echo "$README_CONTENT" | grep -oE "https://[^\s\"]+\.yaml" | grep "free-clash-v2ray" || true)
          
          if [ -n "$CLASH_LINKS" ]; then
            CLASH_URL=$(echo "$CLASH_LINKS" | python3 -c "
import sys, re
links = sys.stdin.read().strip().split('\n')
dated_links = []
for link in links:
    match = re.search(r'/(\d{8})\.yaml', link)
    if match:
        date_str = match.group(1)
        dated_links.append((date_str, link))

if dated_links:
    dated_links.sort(reverse=True)
    print(dated_links[0][1])
else:
    print(links[0] if links else '')
" 2>/dev/null)
          fi
        fi
        
        # å¦‚æœæ²¡æœ‰æå–åˆ°é“¾æ¥ï¼Œä½¿ç”¨å¤‡ç”¨
        V2RAY_URL=${V2RAY_URL:-"https://free-clash-v2ray.github.io/uploads/2026/02/0-20260216.txt"}
        CLASH_URL=${CLASH_URL:-"https://free-clash-v2ray.github.io/uploads/2026/02/0-20260216.yaml"}
        
        echo "âœ… æå–ç»“æœ:"
        echo "V2Ray: $V2RAY_URL"
        echo "Clash: $CLASH_URL"
        
        # === 4. ä¸‹è½½è®¢é˜…æº ===
        echo "â¬‡ï¸ ä¸‹è½½V2Rayè®¢é˜…æº..."
        if curl -s -L "$V2RAY_URL" -o feeds/v2ray-latest.txt --max-time 30; then
          V2RAY_COUNT=$(wc -l < feeds/v2ray-latest.txt 2>/dev/null || echo 0)
          echo "âœ… V2Rayä¸‹è½½æˆåŠŸï¼Œè¡Œæ•°: $V2RAY_COUNT"
        else
          echo "âŒ V2Rayä¸‹è½½å¤±è´¥ï¼Œä½¿ç”¨ç©ºæ–‡ä»¶"
          echo "# V2Rayè®¢é˜…æºæš‚æ—¶ä¸å¯ç”¨" > feeds/v2ray-latest.txt
          UPDATE_STATUS="partial_failure"
          ERROR_MSG="${ERROR_MSG}V2Rayä¸‹è½½å¤±è´¥; "
        fi
        
        echo "â¬‡ï¸ ä¸‹è½½Clashè®¢é˜…æº..."
        if curl -s -L "$CLASH_URL" -o feeds/clash-latest.yaml --max-time 30; then
          CLASH_COUNT=$(wc -l < feeds/clash-latest.yaml 2>/dev/null || echo 0)
          echo "âœ… Clashä¸‹è½½æˆåŠŸï¼Œè¡Œæ•°: $CLASH_COUNT"
        else
          echo "âŒ Clashä¸‹è½½å¤±è´¥ï¼Œä½¿ç”¨ç©ºæ–‡ä»¶"
          echo "# Clashè®¢é˜…æºæš‚æ—¶ä¸å¯ç”¨" > feeds/clash-latest.yaml
          UPDATE_STATUS="partial_failure"
          ERROR_MSG="${ERROR_MSG}Clashä¸‹è½½å¤±è´¥; "
        fi
        
        # === 5. åˆ›å»ºçŠ¶æ€é¡µé¢ ===
        echo "ğŸ“„ åˆ›å»ºçŠ¶æ€é¡µé¢..."
        cat > feeds/index.html << EOF
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>è®¢é˜…æºä»£ç†æœåŠ¡</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .card { background: #f5f5f5; padding: 20px; margin: 20px 0; border-radius: 10px; }
        .url { background: white; padding: 10px; border-radius: 5px; font-family: monospace; }
        .success { color: #28a745; }
        .warning { color: #ffc107; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <h1>ğŸ“¡ è®¢é˜…æºä»£ç†æœåŠ¡</h1>
    <p>è‡ªåŠ¨ä»æºé¡¹ç›®åŒæ­¥æœ€æ–°è®¢é˜…æºï¼Œæä¾›å›ºå®šä¸å˜çš„è®¿é—®é“¾æ¥ã€‚</p>
    
    <div class="card">
        <h2>ğŸ“Š æ›´æ–°çŠ¶æ€</h2>
        <p class="success">âœ… æœ€åæ›´æ–°: $(date -u +'%Y-%m-%d %H:%M:%S UTC')</p>
        <p>V2Rayè®¢é˜…: $V2RAY_COUNT è¡Œ</p>
        <p>Clashè®¢é˜…: $CLASH_COUNT è¡Œ</p>
    </div>
    
    <div class="card">
        <h2>V2Rayè®¢é˜…æº</h2>
        <p>å›ºå®šé“¾æ¥ï¼š</p>
        <div class="url">https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/v2ray-latest.txt</div>
    </div>
    
    <div class="card">
        <h2>Clashè®¢é˜…æº</h2>
        <p>å›ºå®šé“¾æ¥ï¼š</p>
        <div class="url">https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/clash-latest.yaml</div>
    </div>
    
    <hr>
    <p>æºé¡¹ç›®: <a href="https://github.com/free-clash-v2ray/free-clash-v2ray.github.io">free-clash-v2ray.github.io</a></p>
    <p>æ›´æ–°é¢‘ç‡: æ¯ä¸¤å¤©è‡ªåŠ¨æ›´æ–°</p>
</body>
</html>
EOF
        
        # === 6. ä¿å­˜é“¾æ¥ä¿¡æ¯ ===
        cat > feeds/latest_links.txt << EOF
V2Ray: $V2RAY_URL
Clash: $CLASH_URL
V2Rayè¡Œæ•°: $V2RAY_COUNT
Clashè¡Œæ•°: $CLASH_COUNT
æ›´æ–°æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
æ›´æ–°çŠ¶æ€: $UPDATE_STATUS
EOF
        
        # è¾“å‡ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "v2ray_count=$V2RAY_COUNT" >> $GITHUB_OUTPUT
        echo "clash_count=$CLASH_COUNT" >> $GITHUB_OUTPUT
        echo "update_status=$UPDATE_STATUS" >> $GITHUB_OUTPUT
        echo "error_msg=$ERROR_MSG" >> $GITHUB_OUTPUT
        
        echo "âœ… è®¢é˜…æºæ›´æ–°å®Œæˆ"
        
    - name: ğŸ’¾ æäº¤æ›´æ”¹
      id: commit-changes
      if: always()
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        HAS_CHANGES=false
        
        if git diff --quiet feeds/; then
          echo "ğŸ“­ æ— æ–‡ä»¶å˜æ›´"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "ğŸ“ æ£€æµ‹åˆ°å˜æ›´ï¼Œæäº¤æ›´æ”¹..."
          git add feeds/
          
          COMMIT_TIME=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          git commit -m "ğŸ”§ è‡ªåŠ¨æ›´æ–°è®¢é˜…æº [$COMMIT_TIME]
          
          â€¢ V2Rayè®¢é˜…: ${{ steps.update-feeds.outputs.v2ray_count }}è¡Œ
          â€¢ Clashè®¢é˜…: ${{ steps.update-feeds.outputs.clash_count }}è¡Œ
          â€¢ æ›´æ–°çŠ¶æ€: ${{ steps.update-feeds.outputs.update_status }}
          
          ç”±GitHub Actionsè‡ªåŠ¨æ‰§è¡Œ"
          
          if git push origin main; then
            echo "âœ… å˜æ›´å·²æäº¤"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ æäº¤å¤±è´¥"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
        fi
        
    - name: ğŸš€ éƒ¨ç½²åˆ°GitHub Pages
      if: steps.commit-changes.outputs.has_changes == 'true'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./feeds
        publish_branch: gh-pages
        keep_files: true
        
    - name: ğŸ”” å‘é€æˆåŠŸé€šçŸ¥
      if: steps.update-feeds.outputs.update_status == 'success' && steps.commit-changes.outputs.has_changes == 'true' && steps.notify-start.outputs.skip_bark == 'false'
      run: |
        echo "âœ… å‘é€æˆåŠŸé€šçŸ¥..."
        
        TITLE="âœ… è®¢é˜…æºæ›´æ–°æˆåŠŸ"
        BODY="è®¢é˜…æºå·²æˆåŠŸæ›´æ–°å¹¶éƒ¨ç½²ï¼\n\nğŸ“¦ ä»“åº“: ${{ github.repository }}\nğŸ• æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\nğŸ“Š æ›´æ–°ç»Ÿè®¡:\nâ€¢ V2Ray: ${{ steps.update-feeds.outputs.v2ray_count }}è¡Œ\nâ€¢ Clash: ${{ steps.update-feeds.outputs.clash_count }}è¡Œ\n\nğŸ”— è®¿é—®åœ°å€:\nhttps://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        
        curl -s -X GET \
          "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}/$TITLE/$BODY?group=subscription-update&sound=paymentsuccess&badge=1&isArchive=1&url=https://github.com/${{ github.repository }}/actions" \
          --max-time 10 || echo "âš ï¸  æˆåŠŸé€šçŸ¥å‘é€å¤±è´¥"
          
    - name: ğŸ”” å‘é€éƒ¨åˆ†å¤±è´¥é€šçŸ¥
      if: steps.update-feeds.outputs.update_status == 'partial_failure' && steps.commit-changes.outputs.has_changes == 'true' && steps.notify-start.outputs.skip_bark == 'false'
      run: |
        echo "âš ï¸  å‘é€éƒ¨åˆ†å¤±è´¥é€šçŸ¥..."
        
        TITLE="âš ï¸ è®¢é˜…æºéƒ¨åˆ†æ›´æ–°"
        BODY="è®¢é˜…æºæ›´æ–°éƒ¨åˆ†æˆåŠŸï¼\n\nğŸ“¦ ä»“åº“: ${{ github.repository }}\nğŸ• æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\nğŸ“Š æ›´æ–°ç»Ÿè®¡:\nâ€¢ V2Ray: ${{ steps.update-feeds.outputs.v2ray_count }}è¡Œ\nâ€¢ Clash: ${{ steps.update-feeds.outputs.clash_count }}è¡Œ\n\nâŒ é”™è¯¯ä¿¡æ¯:\n${{ steps.update-feeds.outputs.error_msg }}\n\nğŸ”— è®¿é—®åœ°å€:\nhttps://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        
        curl -s -X GET \
          "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}/$TITLE/$BODY?group=subscription-update&sound=alarm&badge=2&isArchive=1&url=https://github.com/${{ github.repository }}/actions" \
          --max-time 10 || echo "âš ï¸  éƒ¨åˆ†å¤±è´¥é€šçŸ¥å‘é€å¤±è´¥"
          
    - name: ğŸ”” å‘é€æ— å˜æ›´é€šçŸ¥
      if: steps.update-feeds.outputs.update_status == 'success' && steps.commit-changes.outputs.has_changes == 'false' && steps.notify-start.outputs.skip_bark == 'false'
      run: |
        echo "ğŸ“­ å‘é€æ— å˜æ›´é€šçŸ¥..."
        
        TITLE="ğŸ“­ è®¢é˜…æºæ— æ›´æ–°"
        BODY="è®¢é˜…æºæ£€æŸ¥å®Œæˆï¼Œä½†æœªå‘ç°æ–°çš„æ›´æ–°ã€‚\n\nğŸ“¦ ä»“åº“: ${{ github.repository }}\nğŸ• æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\nğŸ“Š å½“å‰çŠ¶æ€:\nâ€¢ V2Ray: ${{ steps.update-feeds.outputs.v2ray_count }}è¡Œ\nâ€¢ Clash: ${{ steps.update-feeds.outputs.clash_count }}è¡Œ\n\næ‰€æœ‰è®¢é˜…æºå‡ä¸ºæœ€æ–°çŠ¶æ€ã€‚"
        
        curl -s -X GET \
          "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}/$TITLE/$BODY?group=subscription-update&sound=default&isArchive=1" \
          --max-time 10 || echo "âš ï¸  æ— å˜æ›´é€šçŸ¥å‘é€å¤±è´¥"
          
    - name: ğŸ”” å‘é€å®Œå…¨å¤±è´¥é€šçŸ¥
      if: steps.update-feeds.outputs.update_status == 'failed' && steps.notify-start.outputs.skip_bark == 'false'
      run: |
        echo "âŒ å‘é€å®Œå…¨å¤±è´¥é€šçŸ¥..."
        
        TITLE="âŒ è®¢é˜…æºæ›´æ–°å¤±è´¥"
        BODY="è®¢é˜…æºæ›´æ–°å®Œå…¨å¤±è´¥ï¼\n\nğŸ“¦ ä»“åº“: ${{ github.repository }}\nğŸ• æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\nâŒ é”™è¯¯ä¿¡æ¯:\n${{ steps.update-feeds.outputs.error_msg }}\n\nğŸ”§ è¯·æ£€æŸ¥:\n1. æºé¡¹ç›®READMEæ˜¯å¦å¯è®¿é—®\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n3. GitHub Actionsé…ç½®"
        
        curl -s -X GET \
          "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}/$TITLE/$BODY?group=subscription-update&sound=alarm&level=critical&badge=99&isArchive=1&url=https://github.com/${{ github.repository }}/actions" \
          --max-time 10 || echo "âš ï¸  å¤±è´¥é€šçŸ¥å‘é€å¤±è´¥"
          
    - name: ğŸ“Š å·¥ä½œæµæ€»ç»“
      if: always()
      run: |
        echo "=== å·¥ä½œæµæ‰§è¡Œæ€»ç»“ ==="
        echo "ä»“åº“: ${{ github.repository }}"
        echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
        echo "å¼€å§‹æ—¶é—´: ${{ steps.notify-start.outputs.start_time || 'N/A' }}"
        echo "ç»“æŸæ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo ""
        echo "ğŸ“Š æ›´æ–°ç»Ÿè®¡:"
        echo "â€¢ V2Rayè®¢é˜…: ${{ steps.update-feeds.outputs.v2ray_count || 0 }}è¡Œ"
        echo "â€¢ Clashè®¢é˜…: ${{ steps.update-feeds.outputs.clash_count || 0 }}è¡Œ"
        echo "â€¢ æ›´æ–°çŠ¶æ€: ${{ steps.update-feeds.outputs.update_status || 'unknown' }}"
        echo ""
        echo "ğŸ’¾ æ–‡ä»¶å˜æ›´: ${{ steps.commit-changes.outputs.has_changes || 'false' }}"
        echo "ğŸš€ Pageséƒ¨ç½²: ${{ steps.commit-changes.outputs.has_changes == 'true' && 'å·²è§¦å‘' || 'æœªè§¦å‘' }}"
        echo ""
        echo "ğŸ”” Barké€šçŸ¥:"
        echo "â€¢ è®¾å¤‡å¯†é’¥: ${{ secrets.BARK_DEVICE_KEY && 'å·²é…ç½®' || 'æœªé…ç½®' }}"
        echo "â€¢ è·³è¿‡é€šçŸ¥: ${{ steps.notify-start.outputs.skip_bark || 'false' }}"
        echo ""
        echo "ğŸ”— æ‚¨çš„å›ºå®šè®¢é˜…é“¾æ¥:"
        echo "V2Ray: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/v2ray-latest.txt"
        echo "Clash: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/clash-latest.yaml"
        echo "çŠ¶æ€é¡µ: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo "====================="
