name: Update Subscription Feed with Bark Notifications

on:
  schedule:
    - cron: '0 0 */2 * *'
  workflow_dispatch:
    inputs:
      send_test:
        description: 'å‘é€æµ‹è¯•é€šçŸ¥'
        required: false
        default: false
        type: boolean
  push:
    branches: [ main ]

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ”” å‘é€å¼€å§‹é€šçŸ¥
      if: ${{ github.event.inputs.send_test != 'true' }}
      id: notify-start
      run: |
        echo "ğŸ”” å‘é€å·¥ä½œæµå¼€å§‹é€šçŸ¥..."
        if [ -z "${{ secrets.BARK_DEVICE_KEY }}" ]; then
          echo "âš ï¸ BARK_DEVICE_KEYæœªè®¾ç½®ï¼Œè·³è¿‡Barké€šçŸ¥"
          echo "skip_bark=true" >> $GITHUB_OUTPUT
        else
          echo "âœ… Barkè®¾å¤‡å¯†é’¥å·²é…ç½®"
          echo "skip_bark=false" >> $GITHUB_OUTPUT
          TITLE="ğŸ”„ è®¢é˜…æ›´æ–°å¼€å§‹"
          BODY="å¼€å§‹è®¢é˜…æ›´æ–°ä»»åŠ¡\n\nä»“åº“: ${{ github.repository }}\næ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\nè§¦å‘æ–¹å¼: ${{ github.event_name }}"
          curl -s -X GET \
            "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}/$TITLE/$BODY?group=subscription-update&sound=bell&isArchive=1" \
            --max-time 10 || echo "âš ï¸ å¼€å§‹é€šçŸ¥å‘é€å¤±è´¥"
        fi

    - name: ğŸ”” å‘é€æµ‹è¯•é€šçŸ¥ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
      if: ${{ github.event.inputs.send_test == 'true' }}
      run: |
        echo "ğŸ§ª å‘é€æµ‹è¯•é€šçŸ¥..."
        if [ -z "${{ secrets.BARK_DEVICE_KEY }}" ]; then
          echo "âŒ é”™è¯¯: BARK_DEVICE_KEYæœªè®¾ç½®"
          echo "è¯·åœ¨GitHubä»“åº“Secretsä¸­è®¾ç½®BARK_DEVICE_KEY"
          exit 1
        fi
        TITLE="ğŸ”” Barkæµ‹è¯•é€šçŸ¥"
        BODY="è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é€šçŸ¥ï¼Œç”¨äºéªŒè¯Barké…ç½®ã€‚\n\nä»“åº“: ${{ github.repository }}\næ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        curl -s -X GET \
          "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}/$TITLE/$BODY?group=test&sound=bell&badge=1" \
          --max-time 10
        echo "âœ… æµ‹è¯•é€šçŸ¥å·²å‘é€"
        echo "è¯·æ£€æŸ¥æ‚¨çš„iPhoneæ˜¯å¦æ”¶åˆ°é€šçŸ¥"

    - name: ğŸ”„ è§£æå’Œæ›´æ–°è®¢é˜…æº
      id: update-feeds
      # è°ƒç”¨å¤–éƒ¨è„šæœ¬æ‰§è¡Œæ ¸å¿ƒé€»è¾‘
      run: bash ./scripts/update-feeds.sh

- name: ğŸ’¾ æäº¤æ›´æ”¹
      id: commit-changes
      if: always()
      run: |
        echo â€œæ£€æŸ¥æ–‡ä»¶æ›´æ”¹çŠ¶æ€...â€
        git config --local user.email â€œaction@github.comâ€
        git config --local user.name â€œGitHub Actionâ€
        
        # ä½¿ç”¨ git status æ£€æµ‹ feeds/ ç›®å½•ä¸‹çš„æ‰€æœ‰å˜åŒ–ï¼ŒåŒ…æ‹¬æœªè·Ÿè¸ªçš„æ–°æ–‡ä»¶
        FEEDS_CHANGES=$(git status -s feeds/ 2>/dev/null || echo â€œâ€)
        
        if [ -z â€œ$FEEDS_CHANGESâ€ ]; then
          echo â€œğŸ“­ æœªæ£€æµ‹åˆ° feeds/ ç›®å½•ä¸‹çš„æ–‡ä»¶æ›´æ”¹ï¼ˆæˆ– feeds/ ç›®å½•ä¸å­˜åœ¨ï¼‰ã€‚â€
          echo â€œhas_changes=falseâ€ >> $GITHUB_OUTPUT
        else
          echo â€œğŸ“ æ£€æµ‹åˆ°æ›´æ”¹ï¼Œæ­£åœ¨æäº¤...â€
          echo â€œå˜åŠ¨çš„æ–‡ä»¶åˆ—è¡¨ï¼šâ€
          echo â€œ$FEEDS_CHANGESâ€
          
          # å¼ºåˆ¶æ·»åŠ æ‰€æœ‰æ–‡ä»¶ï¼Œç¡®ä¿å³ä½¿è¢« .gitignore å¿½ç•¥ä¹Ÿèƒ½è¢«æäº¤
          git add -f feeds/
          
          COMMIT_TIME=$(date -u +â€˜%Y-%m-%d %H:%M:%S UTCâ€™)
          git commit -m â€œğŸ”§ è‡ªåŠ¨æ›´æ–°è®¢é˜…æº [$COMMIT_TIME]

          â€¢ V2Rayè®¢é˜…: ${{ steps.update-feeds.outputs.v2ray_count }} è¡Œ
          â€¢ Clashè®¢é˜…: ${{ steps.update-feeds.outputs.clash_count }} è¡Œ
          â€¢ æ›´æ–°çŠ¶æ€: ${{ steps.update-feeds.outputs.update_status }}

          ç”±GitHub Actionsè‡ªåŠ¨æ‰§è¡Œâ€
          
          if git push origin main; then
            echo â€œâœ… æ›´æ”¹æäº¤æˆåŠŸâ€
            echo â€œhas_changes=trueâ€ >> $GITHUB_OUTPUT
          else
            echo â€œâŒ æäº¤åˆ° main åˆ†æ”¯å¤±è´¥â€
            echo â€œhas_changes=falseâ€ >> $GITHUB_OUTPUT
            # è®©æ­¥éª¤å¤±è´¥ï¼Œä»¥ä¾¿åœ¨ Actions æ—¥å¿—ä¸­çœ‹åˆ°æ˜ç¡®çš„é”™è¯¯
            exit 1
          fi
        fi

        
    - name: ğŸš€ éƒ¨ç½²åˆ°GitHub Pages
      if: steps.commit-changes.outputs.has_changes == 'true'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./feeds
        publish_branch: gh-pages
        keep_files: true

    - name: ğŸ”” å‘é€æˆåŠŸé€šçŸ¥
      if: steps.update-feeds.outputs.update_status == 'success' && steps.commit-changes.outputs.has_changes == 'true' && steps.notify-start.outputs.skip_bark == 'false'
      run: |
        echo "âœ… å‘é€æˆåŠŸé€šçŸ¥..."
        TITLE="âœ… è®¢é˜…æ›´æ–°æˆåŠŸ"
        BODY="è®¢é˜…æºå·²æˆåŠŸæ›´æ–°å¹¶éƒ¨ç½²ï¼\n\nğŸ“¦ ä»“åº“: ${{ github.repository }}\nğŸ• æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\nğŸ“Š ç»Ÿè®¡ä¿¡æ¯:\nâ€¢ V2Ray: ${{ steps.update-feeds.outputs.v2ray_count }} è¡Œ\nâ€¢ Clash: ${{ steps.update-feeds.outputs.clash_count }} è¡Œ\n\nğŸ”— è®¿é—®URL:\nhttps://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        curl -s -X GET \
          "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}/$TITLE/$BODY?group=subscription-update&sound=paymentsuccess&badge=1&isArchive=1&url=https://kkgithub.com/${{ github.repository }}/actions" \
          --max-time 10 || echo "âš ï¸ æˆåŠŸé€šçŸ¥å‘é€å¤±è´¥"

    - name: ğŸ”” å‘é€éƒ¨åˆ†å¤±è´¥é€šçŸ¥
      if: steps.update-feeds.outputs.update_status == 'partial_failure' && steps.commit-changes.outputs.has_changes == 'true' && steps.notify-start.outputs.skip_bark == 'false'
      run: |
        echo "âš ï¸ å‘é€éƒ¨åˆ†å¤±è´¥é€šçŸ¥..."
        TITLE="âš ï¸ è®¢é˜…éƒ¨åˆ†æ›´æ–°"
        BODY="è®¢é˜…æºéƒ¨åˆ†æ›´æ–°ï¼\n\nğŸ“¦ ä»“åº“: ${{ github.repository }}\nğŸ• æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\nğŸ“Š ç»Ÿè®¡ä¿¡æ¯:\nâ€¢ V2Ray: ${{ steps.update-feeds.outputs.v2ray_count }} è¡Œ\nâ€¢ Clash: ${{ steps.update-feeds.outputs.clash_count }} è¡Œ\n\nâŒ é”™è¯¯ä¿¡æ¯:\n${{ steps.update-feeds.outputs.error_msg }}\n\nğŸ”— è®¿é—®URL:\nhttps://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        curl -s -X GET \
          "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}/$TITLE/$BODY?group=subscription-update&sound=alarm&badge=2&isArchive=1&url=https://kkgithub.com/${{ github.repository }}/actions" \
          --max-time 10 || echo "âš ï¸ éƒ¨åˆ†å¤±è´¥é€šçŸ¥å‘é€å¤±è´¥"

    - name: ğŸ”” å‘é€æ— å˜åŒ–é€šçŸ¥
      if: steps.update-feeds.outputs.update_status == 'success' && steps.commit-changes.outputs.has_changes == 'false' && steps.notify-start.outputs.skip_bark == 'false'
      run: |
        echo "ğŸ“­ å‘é€æ— å˜åŒ–é€šçŸ¥..."
        TITLE="ğŸ“­ æ— è®¢é˜…æ›´æ–°"
        BODY="è®¢é˜…æ£€æŸ¥å®Œæˆï¼Œä½†æœªå‘ç°æ–°æ›´æ–°ã€‚\n\nğŸ“¦ ä»“åº“: ${{ github.repository }}\nğŸ• æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\nğŸ“Š å½“å‰çŠ¶æ€:\nâ€¢ V2Ray: ${{ steps.update-feeds.outputs.v2ray_count }} è¡Œ\nâ€¢ Clash: ${{ steps.update-feeds.outputs.clash_count }} è¡Œ\n\næ‰€æœ‰è®¢é˜…æºéƒ½æ˜¯æœ€æ–°çš„ã€‚"
        curl -s -X GET \
          "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}/$TITLE/$BODY?group=subscription-update&sound=default&isArchive=1" \
          --max-time 10 || echo "âš ï¸ æ— å˜åŒ–é€šçŸ¥å‘é€å¤±è´¥"

    - name: ğŸ”” å‘é€å®Œå…¨å¤±è´¥é€šçŸ¥
      if: steps.update-feeds.outputs.update_status == 'failed' && steps.notify-start.outputs.skip_bark == 'false'
      run: |
        echo "âŒ å‘é€å®Œå…¨å¤±è´¥é€šçŸ¥..."
        TITLE="âŒ è®¢é˜…æ›´æ–°å¤±è´¥"
        BODY="è®¢é˜…æ›´æ–°å®Œå…¨å¤±è´¥ï¼\n\nğŸ“¦ ä»“åº“: ${{ github.repository }}\nğŸ• æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\nâŒ é”™è¯¯ä¿¡æ¯:\n${{ steps.update-feeds.outputs.error_msg }}\n\nğŸ”§ è¯·æ£€æŸ¥:\n1. æºé¡¹ç›®READMEæ˜¯å¦å¯è®¿é—®ï¼Ÿ\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸ï¼Ÿ\n3. GitHub Actionsé…ç½®æ˜¯å¦æ­£ç¡®ï¼Ÿ"
        curl -s -X GET \
          "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}/$TITLE/$BODY?group=subscription-update&sound=alarm&level=critical&badge=99&isArchive=1&url=https://kkgithub.com/${{ github.repository }}/actions" \
          --max-time 10 || echo "âš ï¸ å¤±è´¥é€šçŸ¥å‘é€å¤±è´¥"

    - name: ğŸ“Š å·¥ä½œæµæ‘˜è¦
      if: always()
      run: |
        echo "=== å·¥ä½œæµæ‰§è¡Œæ‘˜è¦ ==="
        echo "ä»“åº“: ${{ github.repository }}"
        echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
        echo "å¼€å§‹æ—¶é—´: ${{ steps.notify-start.outputs.start_time || 'N/A' }}"
        echo "ç»“æŸæ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo ""
        echo "ğŸ“Š æ›´æ–°ç»Ÿè®¡ä¿¡æ¯:"
        echo "â€¢ V2Rayè®¢é˜…: ${{ steps.update-feeds.outputs.v2ray_count || 0 }} è¡Œ"
        echo "â€¢ Clashè®¢é˜…: ${{ steps.update-feeds.outputs.clash_count || 0 }} è¡Œ"
        echo "â€¢ æ›´æ–°çŠ¶æ€: ${{ steps.update-feeds.outputs.update_status || 'unknown' }}"
        echo ""
        echo "ğŸ’¾ æ–‡ä»¶æ›´æ”¹: ${{ steps.commit-changes.outputs.has_changes || 'false' }}"
        echo "ğŸš€ Pageséƒ¨ç½²: ${{ steps.commit-changes.outputs.has_changes == 'true' && 'å·²è§¦å‘' || 'æœªè§¦å‘' }}"
        echo ""
        echo "ğŸ”” Barké€šçŸ¥:"
        echo "â€¢ è®¾å¤‡å¯†é’¥: ${{ secrets.BARK_DEVICE_KEY && 'å·²é…ç½®' || 'æœªé…ç½®' }}"
        echo "â€¢ è·³è¿‡é€šçŸ¥: ${{ steps.notify-start.outputs.skip_bark || 'false' }}"
        echo ""
        echo "ğŸ”— æ‚¨çš„æ°¸ä¹…è®¢é˜…é“¾æ¥:"
        echo "V2Ray: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/v2ray-latest.txt"
        echo "Clash: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/clash-latest.yaml"
        echo "çŠ¶æ€é¡µé¢: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo "====================="
