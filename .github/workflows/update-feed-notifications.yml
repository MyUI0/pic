name: Update Subscription Feed with Bark Notifications

on:
  schedule:
    # æ¯2å¤©çš„UTC 00:00ï¼ˆåŒ—äº¬æ—¶é—´08:00ï¼‰è‡ªåŠ¨è¿è¡Œ
    - cron: '0 0 */2 * *'
  workflow_dispatch:
    inputs:
      send_test:
        description: 'å‘é€æµ‹è¯•é€šçŸ¥'
        required: false
        default: false
        type: boolean
  push:
    branches: [ main ]

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸å·¥ä½œæµæ¨é€æ›´æ”¹åˆ°ä»“åº“
      pages: write     # å…è®¸å·¥ä½œæµéƒ¨ç½²åˆ°GitHub Pages
      id-token: write  # å…è®¸å·¥ä½œæµè·å–OIDCä»¤ç‰Œ
    
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–æ‰€æœ‰å†å²è®°å½•ï¼Œä»¥ä¾¿æ­£ç¡®æ‰§è¡Œgit diff
      
      # æ­¥éª¤2: å‘é€å¼€å§‹é€šçŸ¥ï¼ˆä»…é™è‡ªåŠ¨è§¦å‘ï¼‰
      - name: ğŸ”” å‘é€å¼€å§‹é€šçŸ¥
        if: ${{ github.event.inputs.send_test != 'true' }}
        id: notify-start
        run: |
          echo "ğŸ”” å‘é€å·¥ä½œæµå¼€å§‹é€šçŸ¥..."
          if [ -z "${{ secrets.BARK_DEVICE_KEY }}" ]; then
            echo "âš ï¸ BARK_DEVICE_KEYæœªè®¾ç½®ï¼Œè·³è¿‡Barké€šçŸ¥"
            echo "skip_bark=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Barkè®¾å¤‡å¯†é’¥å·²é…ç½®"
            echo "skip_bark=false" >> $GITHUB_OUTPUT
            TITLE="ğŸ”„ è®¢é˜…æ›´æ–°å¼€å§‹"
            BODY="å¼€å§‹è®¢é˜…æ›´æ–°ä»»åŠ¡\n\nä»“åº“: ${{ github.repository }}\næ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\nè§¦å‘æ–¹å¼: ${{ github.event_name }}"
            
            # å¯¹æ ‡é¢˜å’Œå†…å®¹è¿›è¡ŒURLç¼–ç 
            ENCODED_TITLE=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$TITLE'))")
            ENCODED_BODY=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$BODY'))")
            
            curl -s -X GET \
              "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}/$ENCODED_TITLE/$ENCODED_BODY?group=subscription-update&sound=bell&isArchive=1" \
              --max-time 10 || echo "âš ï¸ å¼€å§‹é€šçŸ¥å‘é€å¤±è´¥"
          fi
      
      # æ­¥éª¤3: å‘é€æµ‹è¯•é€šçŸ¥ï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨ï¼‰
      - name: ğŸ”” å‘é€æµ‹è¯•é€šçŸ¥ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
        if: ${{ github.event.inputs.send_test == 'true' }}
        run: |
          echo "ğŸ§ª å‘é€æµ‹è¯•é€šçŸ¥..."
          if [ -z "${{ secrets.BARK_DEVICE_KEY }}" ]; then
            echo "âŒ é”™è¯¯: BARK_DEVICE_KEYæœªè®¾ç½®"
            echo "è¯·åœ¨GitHubä»“åº“Secretsä¸­è®¾ç½®BARK_DEVICE_KEY"
            exit 1
          fi
          TITLE="ğŸ”” Barkæµ‹è¯•é€šçŸ¥"
          BODY="è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é€šçŸ¥ï¼Œç”¨äºéªŒè¯Barké…ç½®ã€‚\n\nä»“åº“: ${{ github.repository }}\næ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          
          # å¯¹æ ‡é¢˜å’Œå†…å®¹è¿›è¡ŒURLç¼–ç 
          ENCODED_TITLE=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$TITLE'))")
          ENCODED_BODY=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$BODY'))")
          
          curl -s -X GET \
            "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}/$ENCODED_TITLE/$ENCODED_BODY?group=test&sound=bell&badge=1" \
            --max-time 10
          echo "âœ… æµ‹è¯•é€šçŸ¥å·²å‘é€"
          echo "è¯·æ£€æŸ¥æ‚¨çš„iPhoneæ˜¯å¦æ”¶åˆ°é€šçŸ¥"
      
      # æ­¥éª¤4: è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
      - name: ğŸ”§ è®¾ç½®è„šæœ¬æƒé™
        run: chmod +x ./scripts/update-feeds.sh
      
      # æ­¥éª¤5: è§£æå’Œæ›´æ–°è®¢é˜…æºï¼ˆè°ƒç”¨å¤–éƒ¨è„šæœ¬ï¼‰
      - name: ğŸ”„ è§£æå’Œæ›´æ–°è®¢é˜…æº
        id: update-feeds
        run: bash ./scripts/update-feeds.sh
      
      # æ­¥éª¤6: æäº¤æ›´æ”¹åˆ°ä¸»åˆ†æ”¯ï¼ˆå·²ä¿®å¤æ£€æµ‹é€»è¾‘ï¼‰
      - name: ğŸ’¾ æäº¤æ›´æ”¹ï¼ˆç²¾ç¡®æ£€æµ‹å†…å®¹å˜åŒ–ï¼‰
        id: commit-changes
        if: always()
        run: |
          echo "ğŸ” ç²¾ç¡®æ£€æŸ¥æ–‡ä»¶å†…å®¹æ›´æ”¹..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # 1. å¼ºåˆ¶å°†feedsç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶æ·»åŠ åˆ°Gitæš‚å­˜åŒº
          # è¿™ç¡®ä¿äº†æ–°åˆ›å»ºçš„ç›®å½•å’Œæ–‡ä»¶ä¹Ÿèƒ½è¢«è¿½è¸ªåˆ°
          git add -f feeds/
          
          # 2. æ£€æŸ¥æš‚å­˜åŒºï¼ˆstageï¼‰ä¸ä»“åº“ä¸­ä¸Šä¸€æ¬¡æäº¤ï¼ˆHEADï¼‰ä¹‹é—´çš„å®é™…å·®å¼‚
          # `--quiet` é€‰é¡¹è¡¨ç¤ºï¼šæœ‰å·®å¼‚æ—¶è¿”å›éé›¶å€¼ï¼Œæ— å·®å¼‚æ—¶è¿”å›0
          if git diff --cached --quiet -- feeds/; then
            echo "ğŸ“­ æœªæ£€æµ‹åˆ° feeds/ ç›®å½•ä¸‹çš„å®è´¨æ€§å†…å®¹æ›´æ”¹ã€‚"
            # å°†æš‚å­˜åŒºçš„æ›´æ”¹æ¸…ç©ºï¼Œé¿å…æäº¤æ— æ„ä¹‰çš„å…ƒæ•°æ®å˜åŒ–
            git reset HEAD feeds/ > /dev/null 2>&1
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“ æ£€æµ‹åˆ°å®è´¨æ€§å†…å®¹æ›´æ”¹ï¼Œæ­£åœ¨æäº¤..."
            echo "å˜æ›´æ‘˜è¦ï¼š"
            git diff --cached --stat -- feeds/
            COMMIT_TIME=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
            git commit -m "ğŸ”§ è‡ªåŠ¨æ›´æ–°è®¢é˜…æº [$COMMIT_TIME]
            
            â€¢ V2Rayè®¢é˜…: ${{ steps.update-feeds.outputs.v2ray_count }} è¡Œ
            â€¢ Clashè®¢é˜…: ${{ steps.update-feeds.outputs.clash_count }} è¡Œ
            â€¢ æ›´æ–°çŠ¶æ€: ${{ steps.update-feeds.outputs.update_status }}
            
            ç”±GitHub Actionsè‡ªåŠ¨æ‰§è¡Œ"
            if git push origin main; then
              echo "âœ… æ›´æ”¹æäº¤æˆåŠŸ"
              echo "has_changes=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ æäº¤åˆ° main åˆ†æ”¯å¤±è´¥"
              echo "has_changes=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi
      
      # æ­¥éª¤7: éƒ¨ç½²åˆ°GitHub Pagesï¼ˆä»…åœ¨æ£€æµ‹åˆ°æ›´æ”¹æ—¶æ‰§è¡Œï¼‰
      - name: ğŸš€ éƒ¨ç½²åˆ°GitHub Pages
        if: steps.commit-changes.outputs.has_changes == 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./feeds
          publish_branch: gh-pages
          keep_files: true
          force_orphan: true  # ç¡®ä¿gh-pagesåˆ†æ”¯åªåŒ…å«feedsç›®å½•å†…å®¹
      
      # æ­¥éª¤8: å‘é€æˆåŠŸé€šçŸ¥
      - name: ğŸ”” å‘é€æˆåŠŸé€šçŸ¥
        if: steps.update-feeds.outputs.update_status == 'success' && steps.commit-changes.outputs.has_changes == 'true' && steps.notify-start.outputs.skip_bark == 'false'
        run: |
          echo "âœ… å‘é€æˆåŠŸé€šçŸ¥..."
          TITLE="âœ… è®¢é˜…æ›´æ–°æˆåŠŸ"
          BODY="è®¢é˜…æºå·²æˆåŠŸæ›´æ–°å¹¶éƒ¨ç½²ï¼\n\nğŸ“¦ ä»“åº“: ${{ github.repository }}\nğŸ• æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\nğŸ“Š ç»Ÿè®¡ä¿¡æ¯:\nâ€¢ V2Ray: ${{ steps.update-feeds.outputs.v2ray_count }} è¡Œ\nâ€¢ Clash: ${{ steps.update-feeds.outputs.clash_count }} è¡Œ\n\nğŸ”— è®¿é—®URL:\n${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          
          # å¯¹æ ‡é¢˜å’Œå†…å®¹è¿›è¡ŒURLç¼–ç 
          ENCODED_TITLE=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$TITLE'))")
          ENCODED_BODY=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$BODY'))")
          
          curl -s -X GET \
            "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}/$ENCODED_TITLE/$ENCODED_BODY?group=subscription-update&sound=paymentsuccess&badge=1&isArchive=1&url=https://github.com/${{ github.repository }}/actions" \
            --max-time 10 || echo "âš ï¸ æˆåŠŸé€šçŸ¥å‘é€å¤±è´¥"
      
      # æ­¥éª¤9: å‘é€éƒ¨åˆ†å¤±è´¥é€šçŸ¥
      - name: ğŸ”” å‘é€éƒ¨åˆ†å¤±è´¥é€šçŸ¥
        if: steps.update-feeds.outputs.update_status == 'partial_failure' && steps.commit-changes.outputs.has_changes == 'true' && steps.notify-start.outputs.skip_bark == 'false'
        run: |
          echo "âš ï¸ å‘é€éƒ¨åˆ†å¤±è´¥é€šçŸ¥..."
          TITLE="âš ï¸ è®¢é˜…éƒ¨åˆ†æ›´æ–°"
          BODY="è®¢é˜…æºéƒ¨åˆ†æ›´æ–°ï¼\n\nğŸ“¦ ä»“åº“: ${{ github.repository }}\nğŸ• æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\nğŸ“Š ç»Ÿè®¡ä¿¡æ¯:\nâ€¢ V2Ray: ${{ steps.update-feeds.outputs.v2ray_count }} è¡Œ\nâ€¢ Clash: ${{ steps.update-feeds.outputs.clash_count }} è¡Œ\n\nâŒ é”™è¯¯ä¿¡æ¯:\n${{ steps.update-feeds.outputs.error_msg }}\n\nğŸ”— è®¿é—®URL:\n${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          
          # å¯¹æ ‡é¢˜å’Œå†…å®¹è¿›è¡ŒURLç¼–ç 
          ENCODED_TITLE=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$TITLE'))")
          ENCODED_BODY=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$BODY'))")
          
          curl -s -X GET \
            "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}/$ENCODED_TITLE/$ENCODED_BODY?group=subscription-update&sound=alarm&badge=2&isArchive=1&url=https://github.com/${{ github.repository }}/actions" \
            --max-time 10 || echo "âš ï¸ éƒ¨åˆ†å¤±è´¥é€šçŸ¥å‘é€å¤±è´¥"
      
      # æ­¥éª¤10: å‘é€æ— å˜åŒ–é€šçŸ¥
      - name: ğŸ”” å‘é€æ— å˜åŒ–é€šçŸ¥
        if: steps.update-feeds.outputs.update_status == 'success' && steps.commit-changes.outputs.has_changes == 'false' && steps.notify-start.outputs.skip_bark == 'false'
        run: |
          echo "ğŸ“­ å‘é€æ— å˜åŒ–é€šçŸ¥..."
          TITLE="ğŸ“­ æ— è®¢é˜…æ›´æ–°"
          BODY="è®¢é˜…æ£€æŸ¥å®Œæˆï¼Œä½†æœªå‘ç°æ–°æ›´æ–°ã€‚\n\nğŸ“¦ ä»“åº“: ${{ github.repository }}\nğŸ• æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\nğŸ“Š å½“å‰çŠ¶æ€:\nâ€¢ V2Ray: ${{ steps.update-feeds.outputs.v2ray_count }} è¡Œ\nâ€¢ Clash: ${{ steps.update-feeds.outputs.clash_count }} è¡Œ\n\næ‰€æœ‰è®¢é˜…æºéƒ½æ˜¯æœ€æ–°çš„ã€‚"
          
          # å¯¹æ ‡é¢˜å’Œå†…å®¹è¿›è¡ŒURLç¼–ç 
          ENCODED_TITLE=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$TITLE'))")
          ENCODED_BODY=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$BODY'))")
          
          curl -s -X GET \
            "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}/$ENCODED_TITLE/$ENCODED_BODY?group=subscription-update&sound=default&isArchive=1" \
            --max-time 10 || echo "âš ï¸ æ— å˜åŒ–é€šçŸ¥å‘é€å¤±è´¥"
      
      # æ­¥éª¤11: å‘é€å®Œå…¨å¤±è´¥é€šçŸ¥
      - name: ğŸ”” å‘é€å®Œå…¨å¤±è´¥é€šçŸ¥
        if: steps.update-feeds.outputs.update_status == 'failed' && steps.notify-start.outputs.skip_bark == 'false'
        run: |
          echo "âŒ å‘é€å®Œå…¨å¤±è´¥é€šçŸ¥..."
          TITLE="âŒ è®¢é˜…æ›´æ–°å¤±è´¥"
          BODY="è®¢é˜…æ›´æ–°å®Œå…¨å¤±è´¥ï¼\n\nğŸ“¦ ä»“åº“: ${{ github.repository }}\nğŸ• æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\nâŒ é”™è¯¯ä¿¡æ¯:\n${{ steps.update-feeds.outputs.error_msg }}\n\nğŸ”§ è¯·æ£€æŸ¥:\n1. æºé¡¹ç›®READMEæ˜¯å¦å¯è®¿é—®ï¼Ÿ\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸ï¼Ÿ\n3. GitHub Actionsé…ç½®æ˜¯å¦æ­£ç¡®ï¼Ÿ"
          
          # å¯¹æ ‡é¢˜å’Œå†…å®¹è¿›è¡ŒURLç¼–ç 
          ENCODED_TITLE=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$TITLE'))")
          ENCODED_BODY=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$BODY'))")
          
          curl -s -X GET \
            "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}/$ENCODED_TITLE/$ENCODED_BODY?group=subscription-update&sound=alarm&level=critical&badge=99&isArchive=1&url=https://github.com/${{ github.repository }}/actions" \
            --max-time 10 || echo "âš ï¸ å¤±è´¥é€šçŸ¥å‘é€å¤±è´¥"
      
      # æ­¥éª¤12: å·¥ä½œæµæ‰§è¡Œæ‘˜è¦ï¼ˆæ— è®ºæˆåŠŸä¸å¦éƒ½æ˜¾ç¤ºï¼‰
      - name: ğŸ“Š å·¥ä½œæµæ‘˜è¦
        if: always()
        run: |
          echo "=== å·¥ä½œæµæ‰§è¡Œæ‘˜è¦ ==="
          echo "ä»“åº“: ${{ github.repository }}"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "è¿è¡ŒID: ${{ github.run_id }}"
          echo "è¿è¡Œåºå·: ${{ github.run_number }}"
          echo "å¼€å§‹æ—¶é—´: ${{ steps.notify-start.outputs.start_time || 'N/A' }}"
          echo "ç»“æŸæ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ğŸ“Š æ›´æ–°ç»Ÿè®¡ä¿¡æ¯:"
          echo "â€¢ V2Rayè®¢é˜…: ${{ steps.update-feeds.outputs.v2ray_count || 0 }} è¡Œ"
          echo "â€¢ Clashè®¢é˜…: ${{ steps.update-feeds.outputs.clash_count || 0 }} è¡Œ"
          echo "â€¢ æ›´æ–°çŠ¶æ€: ${{ steps.update-feeds.outputs.update_status || 'unknown' }}"
          echo ""
          echo "ğŸ’¾ æ–‡ä»¶æ›´æ”¹: ${{ steps.commit-changes.outputs.has_changes || 'false' }}"
          echo "ğŸš€ Pageséƒ¨ç½²: ${{ steps.commit-changes.outputs.has_changes == 'true' && 'å·²è§¦å‘' || 'æœªè§¦å‘' }}"
          echo ""
          echo "ğŸ”” Barké€šçŸ¥çŠ¶æ€:"
          echo "â€¢ è®¾å¤‡å¯†é’¥: ${{ secrets.BARK_DEVICE_KEY && 'å·²é…ç½®' || 'æœªé…ç½®' }}"
          echo "â€¢ è·³è¿‡é€šçŸ¥: ${{ steps.notify-start.outputs.skip_bark || 'false' }}"
          echo ""
          echo "ğŸ”— æ‚¨çš„æ°¸ä¹…è®¢é˜…é“¾æ¥:"
          echo "V2Ray: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/v2ray-latest.txt"
          echo "Clash: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/clash-latest.yaml"
          echo "çŠ¶æ€é¡µé¢: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "====================="
