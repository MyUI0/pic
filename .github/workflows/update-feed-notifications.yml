name: Update Subscription Feed

on:
  schedule:
    - cron: '0 0 */2 * *'
  workflow_dispatch:
    inputs:
      send_test:
        description: 'å‘é€æµ‹è¯•é€šçŸ¥'
        required: false
        default: false
        type: boolean
  push:
    branches: [ main ]

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ”” åˆå§‹åŒ–é€šçŸ¥çŠ¶æ€
      id: notify-init
      run: |
        if [ -z "${{ secrets.BARK_DEVICE_KEY }}" ]; then
          echo "skip_bark=true" >> $GITHUB_OUTPUT
        else
          echo "skip_bark=false" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ”” å‘é€æµ‹è¯•é€šçŸ¥
      if: ${{ github.event.inputs.send_test == 'true' }}
      run: |
        if [ "${{ steps.notify-init.outputs.skip_bark }}" == "true" ]; then
          echo "âŒ BARK_DEVICE_KEYæœªè®¾ç½®"
          exit 1
        fi
        curl -s -X POST "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{
            "title": "æµ‹è¯•é€šçŸ¥",
            "body": "Barké…ç½®æ­£å¸¸",
            "group": "test",
            "sound": "bell",
            "icon": "https://avatars.githubusercontent.com/u/88518685?v=4&size=64"
          }' --max-time 10
        echo "âœ… æµ‹è¯•é€šçŸ¥å·²å‘é€"

    - name: ğŸ”” å‘é€å¼€å§‹é€šçŸ¥
      if: ${{ github.event.inputs.send_test != 'true' && steps.notify-init.outputs.skip_bark == 'false' }}
      run: |
        curl -s -X POST "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{
            "title": "è®¢é˜…æ›´æ–°ä¸­",
            "body": "ä»“åº“: ${{ github.repository }}",
            "group": "subscription-update",
            "sound": "bell",
            "isArchive": 1,
            "icon": "https://avatars.githubusercontent.com/u/88518685?v=4&size=64"
          }' --max-time 10 || true

    - name: ğŸ”§ æ‰§è¡Œæ›´æ–°è„šæœ¬
      id: update-feeds
      run: |
        chmod +x ./scripts/update-feeds.sh
        bash ./scripts/update-feeds.sh

    - name: ğŸ’¾ æäº¤æ›´æ”¹
      id: commit-changes
      if: always()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -f feeds/
        if git diff --cached --quiet -- feeds/; then
          git reset HEAD feeds/ > /dev/null 2>&1
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          git commit -m "ğŸ”§ æ›´æ–°è®¢é˜…æº [$(date -u +'%Y-%m-%d %H:%M:%S UTC')]"
          git push origin main && echo "has_changes=true" >> $GITHUB_OUTPUT || echo "has_changes=false" >> $GITHUB_OUTPUT
        fi

    - name: ğŸš€ éƒ¨ç½²Pages
      if: steps.commit-changes.outputs.has_changes == 'true'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./feeds
        publish_branch: gh-pages
        keep_files: true
        force_orphan: true

    - name: ğŸ”” å‘é€ç»“æœé€šçŸ¥
      if: always() && steps.notify-init.outputs.skip_bark == 'false' && github.event.inputs.send_test != 'true'
      run: |
        # è·å–åŸå§‹é“¾æ¥æ—¥æœŸï¼ˆå¦‚æœupdate-feeds.shè¾“å‡ºäº†çš„è¯ï¼‰
        ORIGINAL_DATE="${{ steps.update-feeds.outputs.original_date || 'æœªçŸ¥' }}"
        
        # æ„å»ºé€šçŸ¥å†…å®¹
        if [ "${{ steps.update-feeds.outputs.update_status }}" == "success" ]; then
          if [ "${{ steps.commit-changes.outputs.has_changes }}" == "true" ]; then
            TITLE="è®¢é˜…å·²æ›´æ–°"
            BODY="V2Ray: ${{ steps.update-feeds.outputs.v2ray_count }}è¡Œ | Clash: ${{ steps.update-feeds.outputs.clash_count }}è¡Œ\næºæ—¥æœŸ: $ORIGINAL_DATE"
            SOUND="paymentsuccess"
            BADGE=1
          else
            TITLE="è®¢é˜…æ— æ›´æ–°"
            BODY="æºæ—¥æœŸ: $ORIGINAL_DATE"
            SOUND="default"
            BADGE=0
          fi
        else
          TITLE="è®¢é˜…æ›´æ–°å¤±è´¥"
          BODY="è¯·æ£€æŸ¥æºé“¾æ¥"
          SOUND="alarm"
          BADGE=99
        fi
        
        # å‘é€é€šçŸ¥
        curl -s -X POST "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{
            "title": "'"$TITLE"'",
            "body": "'"$BODY"'",
            "group": "subscription-update",
            "sound": "'"$SOUND"'",
            "badge": '$BADGE',
            "isArchive": 1,
            "icon": "https://avatars.githubusercontent.com/u/88518685?v=4&size=64"
          }' --max-time 10 || true

    - name: ğŸ“Š å·¥ä½œæµæ‘˜è¦
      if: always()
      run: |
        echo "=== æ‰§è¡Œæ‘˜è¦ ==="
        echo "ä»“åº“: ${{ github.repository }}"
        echo "è§¦å‘: ${{ github.event_name }}"
        echo "V2Ray: ${{ steps.update-feeds.outputs.v2ray_count || 0 }}è¡Œ"
        echo "Clash: ${{ steps.update-feeds.outputs.clash_count || 0 }}è¡Œ"
        echo "æºæ—¥æœŸ: ${{ steps.update-feeds.outputs.original_date || 'æœªçŸ¥' }}"
        echo "çŠ¶æ€: ${{ steps.update-feeds.outputs.update_status || 'unknown' }}"
        echo "æ›´æ”¹: ${{ steps.commit-changes.outputs.has_changes || 'false' }}"
        echo "é€šçŸ¥: ${{ steps.notify-init.outputs.skip_bark == 'false' && 'å·²å¯ç”¨' || 'å·²è·³è¿‡' }}"
        echo "==============="
