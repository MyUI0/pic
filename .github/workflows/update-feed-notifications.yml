name: Update Subscription Feed with Bark Notifications

on:
  schedule:
    - cron: '0 0 */2 * *'
  workflow_dispatch:
    inputs:
      send_test:
        description: 'Send test notification'
        required: false
        default: false
        type: boolean
  push:
    branches: [ main ]

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ğŸ”” Send start notification
      if: ${{ github.event.inputs.send_test != 'true' }}
      id: notify-start
      run: |
        echo "ğŸ”” Sending workflow start notification..."
        
        if [ -z "${{ secrets.BARK_DEVICE_KEY }}" ]; then
          echo "âš ï¸ BARK_DEVICE_KEY not set, skipping Bark notification"
          echo "skip_bark=true" >> $GITHUB_OUTPUT
        else
          echo "âœ… Bark device key configured"
          echo "skip_bark=false" >> $GITHUB_OUTPUT
          
          TITLE="ğŸ”„ Subscription Update Started"
          BODY="Starting subscription update task\n\nRepository: ${{ github.repository }}\nTime: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\nTrigger: ${{ github.event_name }}"
          
          curl -s -X GET \
            "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}/$TITLE/$BODY?group=subscription-update&sound=bell&isArchive=1" \
            --max-time 10 || echo "âš ï¸ Start notification failed"
        fi
        
    - name: ğŸ”” Send test notification (manual trigger)
      if: ${{ github.event.inputs.send_test == 'true' }}
      run: |
        echo "ğŸ§ª Sending test notification..."
        
        if [ -z "${{ secrets.BARK_DEVICE_KEY }}" ]; then
          echo "âŒ Error: BARK_DEVICE_KEY not set"
          echo "Please set BARK_DEVICE_KEY in GitHub repository Secrets"
          exit 1
        fi
        
        TITLE="ğŸ”” Bark Test Notification"
        BODY="This is a test notification to verify Bark configuration.\n\nRepository: ${{ github.repository }}\nTime: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        
        curl -s -X GET \
          "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}/$TITLE/$BODY?group=test&sound=bell&badge=1" \
          --max-time 10
        
        echo "âœ… Test notification sent"
        echo "Please check your iPhone for notification"
        
    - name: ğŸ”„ Parse and update feeds
      id: update-feeds
      run: |
        # Create feeds directory
        mkdir -p feeds
        
        # Initialize variables
        V2RAY_COUNT=0
        CLASH_COUNT=0
        UPDATE_STATUS="success"
        ERROR_MSG=""
        
        # === 1. Get README content ===
        echo "ğŸ” Fetching source project README..."
        README_URL="https://raw.githubusercontent.com/free-clash-v2ray/free-clash-v2ray.github.io/main/README.md"
        README_CONTENT=$(curl -s -L "$README_URL" --max-time 30 2>/dev/null || echo "")
        
        if [ -z "$README_CONTENT" ]; then
          echo "âš ï¸ Cannot fetch README, using fallback links"
          V2RAY_URL="https://free-clash-v2ray.github.io/uploads/2026/02/0-20260216.txt"
          CLASH_URL="https://free-clash-v2ray.github.io/uploads/2026/02/0-20260216.yaml"
        else
          # === 2. Extract latest V2Ray links ===
          echo "ğŸ” Extracting V2Ray links..."
          V2RAY_LINKS=$(echo "$README_CONTENT" | grep -oE "https://[^\s\"]+\.txt" | grep "free-clash-v2ray" || true)
          
          if [ -n "$V2RAY_LINKS" ]; then
            # Extract the link with latest date
            V2RAY_URL=$(echo "$V2RAY_LINKS" | python3 -c "
import sys, re

# Read all links from stdin
links = sys.stdin.read().strip().split('\n')
dated_links = []

for link in links:
    # Extract date from filename like 0-20260216.txt
    match = re.search(r'/(\d{8})\.txt', link)
    if match:
        date_str = match.group(1)
        dated_links.append((date_str, link))

if dated_links:
    # Sort by date descending (newest first)
    dated_links.sort(reverse=True)
    print(dated_links[0][1])  # Print the newest link
else:
    # No date found, use first link
    print(links[0] if links else '')
" 2>/dev/null || echo "")
          fi
          
          # === 3. Extract latest Clash links ===
          echo "ğŸ” Extracting Clash links..."
          CLASH_LINKS=$(echo "$README_CONTENT" | grep -oE "https://[^\s\"]+\.yaml" | grep "free-clash-v2ray" || true)
          
          if [ -n "$CLASH_LINKS" ]; then
            CLASH_URL=$(echo "$CLASH_LINKS" | python3 -c "
import sys, re

links = sys.stdin.read().strip().split('\n')
dated_links = []

for link in links:
    match = re.search(r'/(\d{8})\.yaml', link)
    if match:
        date_str = match.group(1)
        dated_links.append((date_str, link))

if dated_links:
    dated_links.sort(reverse=True)
    print(dated_links[0][1])
else:
    print(links[0] if links else '')
" 2>/dev/null || echo "")
          fi
        fi
        
        # Use fallback if no links extracted
        V2RAY_URL=${V2RAY_URL:-"https://free-clash-v2ray.github.io/uploads/2026/02/0-20260216.txt"}
        CLASH_URL=${CLASH_URL:-"https://free-clash-v2ray.github.io/uploads/2026/02/0-20260216.yaml"}
        
        echo "âœ… Extraction results:"
        echo "V2Ray: $V2RAY_URL"
        echo "Clash: $CLASH_URL"
        
        # === 4. Download subscription feeds ===
        echo "â¬‡ï¸ Downloading V2Ray feed..."
        if curl -s -L "$V2RAY_URL" -o feeds/v2ray-latest.txt --max-time 30; then
          V2RAY_COUNT=$(wc -l < feeds/v2ray-latest.txt 2>/dev/null || echo 0)
          echo "âœ… V2Ray download successful, lines: $V2RAY_COUNT"
        else
          echo "âŒ V2Ray download failed, using empty file"
          echo "# V2Ray subscription temporarily unavailable" > feeds/v2ray-latest.txt
          UPDATE_STATUS="partial_failure"
          ERROR_MSG="${ERROR_MSG}V2Ray download failed; "
        fi
        
        echo "â¬‡ï¸ Downloading Clash feed..."
        if curl -s -L "$CLASH_URL" -o feeds/clash-latest.yaml --max-time 30; then
          CLASH_COUNT=$(wc -l < feeds/clash-latest.yaml 2>/dev/null || echo 0)
          echo "âœ… Clash download successful, lines: $CLASH_COUNT"
        else
          echo "âŒ Clash download failed, using empty file"
          echo "# Clash subscription temporarily unavailable" > feeds/clash-latest.yaml
          UPDATE_STATUS="partial_failure"
          ERROR_MSG="${ERROR_MSG}Clash download failed; "
        fi
        
        # === 5. Create status page ===
        echo "ğŸ“„ Creating status page..."
        cat > feeds/index.html << EOF
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Subscription Proxy Service</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .card { background: #f5f5f5; padding: 20px; margin: 20px 0; border-radius: 10px; }
        .url { background: white; padding: 10px; border-radius: 5px; font-family: monospace; }
        .success { color: #28a745; }
        .warning { color: #ffc107; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <h1>ğŸ“¡ Subscription Proxy Service</h1>
    <p>Automatically syncs latest subscription feeds, provides permanent access links.</p>
    
    <div class="card">
        <h2>ğŸ“Š Update Status</h2>
        <p class="success">âœ… Last updated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')</p>
        <p>V2Ray subscription: $V2RAY_COUNT lines</p>
        <p>Clash subscription: $CLASH_COUNT lines</p>
    </div>
    
    <div class="card">
        <h2>V2Ray Subscription</h2>
        <p>Permanent link:</p>
        <div class="url">https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/v2ray-latest.txt</div>
    </div>
    
    <div class="card">
        <h2>Clash Subscription</h2>
        <p>Permanent link:</p>
        <div class="url">https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/clash-latest.yaml</div>
    </div>
    
    <hr>
    <p>Source project: <a href="https://github.com/free-clash-v2ray/free-clash-v2ray.github.io">free-clash-v2ray.github.io</a></p>
    <p>Update frequency: Automatically every 2 days</p>
</body>
</html>
EOF
        
        # === 6. Save link info ===
        cat > feeds/latest_links.txt << EOF
V2Ray: $V2RAY_URL
Clash: $CLASH_URL
V2Ray lines: $V2RAY_COUNT
Clash lines: $CLASH_COUNT
Update time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
Update status: $UPDATE_STATUS
EOF
        
        # Output variables for later steps
        echo "v2ray_count=$V2RAY_COUNT" >> $GITHUB_OUTPUT
        echo "clash_count=$CLASH_COUNT" >> $GITHUB_OUTPUT
        echo "update_status=$UPDATE_STATUS" >> $GITHUB_OUTPUT
        echo "error_msg=$ERROR_MSG" >> $GITHUB_OUTPUT
        
        echo "âœ… Feed update completed"
        
    - name: ğŸ’¾ Commit changes
      id: commit-changes
      if: always()
      run: |
        echo "Checking for file changes..."
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        HAS_CHANGES=false
        
        if git diff --quiet feeds/; then
          echo "ğŸ“­ No file changes detected"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "ğŸ“ Detected changes, committing..."
          git add feeds/
          
          COMMIT_TIME=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          git commit -m "ğŸ”§ Auto-update subscription feeds [$COMMIT_TIME]
          
          â€¢ V2Ray subscription: ${{ steps.update-feeds.outputs.v2ray_count }} lines
          â€¢ Clash subscription: ${{ steps.update-feeds.outputs.clash_count }} lines
          â€¢ Update status: ${{ steps.update-feeds.outputs.update_status }}
          
          Automated by GitHub Actions"
          
          if git push origin main; then
            echo "âœ… Changes committed successfully"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Commit failed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
        fi
        
    - name: ğŸš€ Deploy to GitHub Pages
      if: steps.commit-changes.outputs.has_changes == 'true'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./feeds
        publish_branch: gh-pages
        keep_files: true
        
    - name: ğŸ”” Send success notification
      if: steps.update-feeds.outputs.update_status == 'success' && steps.commit-changes.outputs.has_changes == 'true' && steps.notify-start.outputs.skip_bark == 'false'
      run: |
        echo "âœ… Sending success notification..."
        
        TITLE="âœ… Subscription Update Successful"
        BODY="Subscription feeds updated and deployed successfully!\n\nğŸ“¦ Repository: ${{ github.repository }}\nğŸ• Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\nğŸ“Š Statistics:\nâ€¢ V2Ray: ${{ steps.update-feeds.outputs.v2ray_count }} lines\nâ€¢ Clash: ${{ steps.update-feeds.outputs.clash_count }} lines\n\nğŸ”— Access URL:\nhttps://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        
        curl -s -X GET \
          "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}/$TITLE/$BODY?group=subscription-update&sound=paymentsuccess&badge=1&isArchive=1&url=https://github.com/${{ github.repository }}/actions" \
          --max-time 10 || echo "âš ï¸ Success notification failed"
          
    - name: ğŸ”” Send partial failure notification
      if: steps.update-feeds.outputs.update_status == 'partial_failure' && steps.commit-changes.outputs.has_changes == 'true' && steps.notify-start.outputs.skip_bark == 'false'
      run: |
        echo "âš ï¸ Sending partial failure notification..."
        
        TITLE="âš ï¸ Subscription Partially Updated"
        BODY="Subscription feeds partially updated!\n\nğŸ“¦ Repository: ${{ github.repository }}\nğŸ• Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\nğŸ“Š Statistics:\nâ€¢ V2Ray: ${{ steps.update-feeds.outputs.v2ray_count }} lines\nâ€¢ Clash: ${{ steps.update-feeds.outputs.clash_count }} lines\n\nâŒ Error message:\n${{ steps.update-feeds.outputs.error_msg }}\n\nğŸ”— Access URL:\nhttps://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        
        curl -s -X GET \
          "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}/$TITLE/$BODY?group=subscription-update&sound=alarm&badge=2&isArchive=1&url=https://github.com/${{ github.repository }}/actions" \
          --max-time 10 || echo "âš ï¸ Partial failure notification failed"
          
    - name: ğŸ”” Send no changes notification
      if: steps.update-feeds.outputs.update_status == 'success' && steps.commit-changes.outputs.has_changes == 'false' && steps.notify-start.outputs.skip_bark == 'false'
      run: |
        echo "ğŸ“­ Sending no changes notification..."
        
        TITLE="ğŸ“­ No Subscription Updates"
        BODY="Subscription check completed, but no new updates found.\n\nğŸ“¦ Repository: ${{ github.repository }}\nğŸ• Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\nğŸ“Š Current status:\nâ€¢ V2Ray: ${{ steps.update-feeds.outputs.v2ray_count }} lines\nâ€¢ Clash: ${{ steps.update-feeds.outputs.clash_count }} lines\n\nAll subscription feeds are up to date."
        
        curl -s -X GET \
          "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}/$TITLE/$BODY?group=subscription-update&sound=default&isArchive=1" \
          --max-time 10 || echo "âš ï¸ No changes notification failed"
          
    - name: ğŸ”” Send complete failure notification
      if: steps.update-feeds.outputs.update_status == 'failed' && steps.notify-start.outputs.skip_bark == 'false'
      run: |
        echo "âŒ Sending complete failure notification..."
        
        TITLE="âŒ Subscription Update Failed"
        BODY="Subscription update completely failed!\n\nğŸ“¦ Repository: ${{ github.repository }}\nğŸ• Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\nâŒ Error message:\n${{ steps.update-feeds.outputs.error_msg }}\n\nğŸ”§ Please check:\n1. Is the source project README accessible?\n2. Is the network connection normal?\n3. Is the GitHub Actions configuration correct?"
        
        curl -s -X GET \
          "https://api.day.app/${{ secrets.BARK_DEVICE_KEY }}/$TITLE/$BODY?group=subscription-update&sound=alarm&level=critical&badge=99&isArchive=1&url=https://github.com/${{ github.repository }}/actions" \
          --max-time 10 || echo "âš ï¸ Failure notification failed"
          
    - name: ğŸ“Š Workflow summary
      if: always()
      run: |
        echo "=== Workflow Execution Summary ==="
        echo "Repository: ${{ github.repository }}"
        echo "Trigger: ${{ github.event_name }}"
        echo "Start time: ${{ steps.notify-start.outputs.start_time || 'N/A' }}"
        echo "End time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo ""
        echo "ğŸ“Š Update statistics:"
        echo "â€¢ V2Ray subscription: ${{ steps.update-feeds.outputs.v2ray_count || 0 }} lines"
        echo "â€¢ Clash subscription: ${{ steps.update-feeds.outputs.clash_count || 0 }} lines"
        echo "â€¢ Update status: ${{ steps.update-feeds.outputs.update_status || 'unknown' }}"
        echo ""
        echo "ğŸ’¾ File changes: ${{ steps.commit-changes.outputs.has_changes || 'false' }}"
        echo "ğŸš€ Pages deployment: ${{ steps.commit-changes.outputs.has_changes == 'true' && 'Triggered' || 'Not triggered' }}"
        echo ""
        echo "ğŸ”” Bark notifications:"
        echo "â€¢ Device key: ${{ secrets.BARK_DEVICE_KEY && 'Configured' || 'Not configured' }}"
        echo "â€¢ Skip notifications: ${{ steps.notify-start.outputs.skip_bark || 'false' }}"
        echo ""
        echo "ğŸ”— Your permanent subscription links:"
        echo "V2Ray: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/v2ray-latest.txt"
        echo "Clash: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/clash-latest.yaml"
        echo "Status page: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo "====================="
